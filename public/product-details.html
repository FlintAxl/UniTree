<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Details - UniTree</title>

  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/product-details.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
  <!-- Header -->
  <div id="header"></div>
  <script>$('#header').load('header.html');</script>

  <!-- Main container -->
  <div class="container" style="padding: 2rem 5%;">

    <!-- Loading spinner -->
    <div id="loadingSpinner" class="loading-spinner text-center">
      <div class="spinner-border" role="status"></div>
      <p class="mt-3 text-muted fw-bold">Loading product details...</p>
    </div>

    <!-- Error message -->
    <div id="errorMessage" class="alert alert-danger d-none" role="alert">
      <i class="fas fa-exclamation-circle me-2"></i> Failed to load product details. Please try again later.
    </div>

    <!-- Back button -->
    <a href="products.html" class="back-button"><i class="fas fa-arrow-left"></i> Back to Products</a>

    <!-- Product Details Section -->
    <div id="productDetails" class="d-none">
      <div class="row">

        <!-- Product Images -->
        <div class="col-lg-6">
          <div class="product-gallery">
            <img id="mainImage" src="" alt="Product Image" class="main-image" />
            <div class="thumbnail-container" id="thumbnailsContainer"></div>
          </div>
        </div>

        <!-- Product Info -->
        <div class="col-lg-6">
          <div class="product-info">
            <h1 id="productTitle" class="product-title"></h1>
            <div id="productCategory" class="product-category">
              <i class="fas fa-tag"></i> <span></span>
            </div>
            <div id="productPrice" class="product-price"></div>

            <!-- Stock status -->
            <div id="stockStatus" class="stock-status in-stock">
              <i class="fas fa-check-circle"></i> <span id="stockText">In Stock</span>
            </div>

            <div id="productDescription" class="product-description"></div>

            <!-- Action buttons -->
            <div class="action-buttons">
              <div class="quantity-controls">
                <button type="button" id="decreaseQty">−</button>
                <input type="number" value="1" min="1" id="quantity" />
                <button type="button" id="increaseQty">+</button>
              </div>
              <button class="btn btn-primary btn-add-cart" id="addToCartBtn">
                <i class="fas fa-shopping-cart"></i> Add to Cart
              </button>
              <button class="btn btn-outline btn-buy-now">
                <i class="fas fa-bolt"></i> Buy Now
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs Section -->
      <div class="product-tabs mt-4">
        <ul class="nav nav-tabs">
          <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#desc">
              <i class="fas fa-info-circle me-2"></i>Description
            </button>
          </li>
        </ul>
        <div class="tab-content p-3 border border-top-0" id="desc">
          <div id="productFullDescription"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer mt-5">
    <div class="footer-content">
      <div>
        <h3>UniTree</h3>
        <p>The University's largest marketplace for accessible products.</p>
      </div>
    </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/cart.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const productId = new URLSearchParams(window.location.search).get('id');
      const apiUrl = 'http://localhost:3000/api/v1';

      // no product ID, show error
      if (!productId) return $('#errorMessage').removeClass('d-none').text('No product ID specified.');

      // product details
      $.get(`${apiUrl}/products/${productId}`)
        .done(res => {
          if (!res || !res.success) return showError('Product not found.');
          const p = res.product;

          const product = {
            id: p.id || p.product_id,
            name: p.name || p.title || 'Unnamed Product',
            price: parseFloat(p.price) || 0,
            image: Array.isArray(p.images) && p.images[0]
              ? (p.images[0].startsWith('http') ? p.images[0] : `/${p.images[0]}`)
              : 'images/placeholder.jpg',
            description: p.description || 'No description available.',
            stock: p.stock || 0
          };

          // product details in UI
          $('#productTitle').text(product.name);
          $('#productPrice').text('₱' + product.price.toFixed(2));
          $('#productDescription').text(product.description);
          $('#productFullDescription').html(`<p>${product.description}</p>`);
          $('#mainImage').attr('src', product.image);
          $('#productDetails').removeClass('d-none');

          // stock status
          if (product.stock <= 0) {
            $('#stockText').text('Out of Stock');
            $('#addToCartBtn, .btn-buy-now').prop('disabled', true);
          }

          // product data to buttons
          $('#addToCartBtn, .btn-buy-now')
            .attr('data-id', product.id)
            .attr('data-name', product.name)
            .attr('data-price', product.price)
            .attr('data-image', product.image);
        })
        .fail(() => showError('Failed to load product details.'))
        .always(() => $('#loadingSpinner').hide());

      // error message
      function showError(msg) {
        $('#loadingSpinner').hide();
        $('#errorMessage').removeClass('d-none').text(msg);
      }

      // add to Cart & Buy Now 
      $('#addToCartBtn, .btn-buy-now').on('click', function(e) {
        e.stopImmediatePropagation(); 
        e.preventDefault();

        const quantity = parseInt($('#quantity').val()) || 1;
        const redirectToCart = $(this).hasClass('btn-buy-now');

        const product = {
          id: $(this).data('id'),
          name: $(this).data('name'),
          price: $(this).data('price'),
          image: $(this).data('image'),
        };

        const originalShowToast = window.showToast;
        window.showToast = function() {};

        // multiple items to cart
        for (let i = 0; i < quantity; i++) {
          addToCart(product, false); 
        }

        // toast and show message
        window.showToast = originalShowToast;
        showToast(`${product.name} (x${quantity}) added to cart`);

        // buy now
        if (redirectToCart) {
          setTimeout(() => {
            window.location.href = 'cart.html';
          }, 1000);
        }
      });

      // quantity
      $('#increaseQty').click(() => {
        let qty = parseInt($('#quantity').val());
        $('#quantity').val(qty + 1);
      });

      $('#decreaseQty').click(() => {
        let qty = parseInt($('#quantity').val());
        if (qty > 1) {
          $('#quantity').val(qty - 1);
        }
      });
    });
  </script>

  <script src="js/user.js"></script>
</body>
</html>
